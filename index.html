<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸª Ù…ØªØ¬Ø± Ù…Ø§Ø³ÙŠÙˆ</title>
<style>
body {
  font-family: 'Tahoma', sans-serif;
  margin: 0;
  padding: 0;
  background: #fff;
}
header {
  background: #007bff;
  color: #fff;
  padding: 8px;
  text-align: center;
  overflow: hidden;
  position: relative;
}
.marquee {
  display: inline-block;
  white-space: nowrap;
  animation: scroll-left 10s linear infinite;
  font-size: 15px;
}
@keyframes scroll-left {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}
nav {
  background: #f8f9fa;
  display: flex;
  justify-content: space-around;
  padding: 8px;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}
nav a {
  text-decoration: none;
  color: #333;
  font-size: 14px;
}
nav a:hover {
  color: #007bff;
}
section {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  padding: 10px;
}
.card {
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 6px;
  text-align: center;
}
.card img {
  width: 100%;
  max-height: 120px;
  object-fit: cover;
  border-radius: 4px;
}
button {
  background: #28a745;
  color: #fff;
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 4px;
}
button:hover {
  background: #218838;
}
.cart-link {
  color: #fff;
  text-decoration: none;
  position: absolute;
  left: 15px;
  top: 8px;
}
.cart-link:hover {
  text-decoration: underline;
}
.cart-count {
  background: #dc3545;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 12px;
}
footer {
  background: #f1f1f1;
  text-align: center;
  padding: 6px;
  font-size: 12px;
  color: #777;
  border-top: 1px solid #ddd;
  margin-top: 6px;
}
/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙƒÙ…ÙŠØ© */
.quantity-control {
  margin: 8px 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
.quantity-label {
  margin-left: 5px;
}
.quantity-select {
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #ddd;
  width: 60px;
}
.error-message {
  color: red;
  font-size: 12px;
  margin-top: 5px;
  display: none;
}
</style>
</head>
<body>

<header>
  <a href="cart.html" class="cart-link">ğŸ›’ Ø§Ù„Ø³Ù„Ø© (<span class="cart-count">0</span>)</a>
  <span class="marquee" id="userInfo">... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ...</span>
</header>

<nav>
  <a href="index.html">ğŸª Ø§Ù„Ù…ØªØ¬Ø±</a>
  <a href="cart.html">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</a>
  <a href="register.html">ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ</a>
</nav>

<section id="storeSection">
  <p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹...</p>
</section>

<footer>ğŸ’ Ù…ØªØ¬Ø± Ù…Ø§Ø³ÙŠÙˆ Â© 2023 ğŸ’</footer>

<script>
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø©
let cart = JSON.parse(localStorage.getItem('cart')) || [];
const PRODUCTS_URL = 'https://dl.dropboxusercontent.com/scl/fi/uxlue3uda1dlj087nbhig/products.json?rlkey=7nsi66nha7wbc7hr8uasej9g9&st=bav15vxr';

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø©
function updateCartCount() {
  document.querySelector('.cart-count').textContent = cart.length;
}

// Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
function goToCart() {
  if (cart.length === 0) {
    alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
    return false;
  }
  location.href = 'cart.html';
  return true;
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ©
function addToCartWithQuantity(productId, productName, productPrice, productImg) {
  const quantitySelect = document.getElementById(`qty-${productId}`);
  const quantity = parseInt(quantitySelect.value);
  const errorElement = document.getElementById(`error-${productId}`);

  if (quantity === 0) {
    errorElement.style.display = 'block';
    errorElement.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±';
    return;
  }
  
  errorElement.style.display = 'none';

  const existingItem = cart.find(item => item.id === productId);
  
  if (existingItem) {
    existingItem.quantity += quantity;
  } else {
    cart.push({
      id: productId,
      name: productName,
      price: productPrice,
      img: productImg,
      quantity: quantity
    });
  }
  
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
  
  if (confirm(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${quantity} Ù…Ù† "${productName}" Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¢Ù†ØŸ`)) {
    goToCart();
  } else {
    quantitySelect.value = '0'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Dropbox
async function loadProducts() {
  try {
    const res = await fetch(PRODUCTS_URL);
    if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
    const products = await res.json();
    renderStore(products);
    
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    localStorage.setItem('cachedProducts', JSON.stringify(products));
  } catch (e) {
    console.error('Ø­Ø¯Ø« Ø®Ø·Ø£:', e);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
    const cachedProducts = localStorage.getItem('cachedProducts');
    if (cachedProducts) {
      renderStore(JSON.parse(cachedProducts));
      return;
    }
    
    document.getElementById('storeSection').innerHTML = `
      <div style="grid-column:1/-1;text-align:center;color:red;">
        âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
      </div>
    `;
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ©
function renderStore(products) {
  let html = "";
  products.forEach((p, i) => {
    html += `
    <div class="card">
      <img src="${p.img}" alt="${p.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
      <h4>${p.name}</h4>
      <p>Ø§Ù„Ø³Ø¹Ø±: ${p.price} Ø¬Ù†ÙŠÙ‡</p>
      <p style="font-size:12px;color:#555;">${p.details}</p>
      
      <div class="quantity-control">
        <select id="qty-${i}" class="quantity-select">
          ${Array.from({length: 10}, (_, index) => 
            `<option value="${index}">${index}</option>`
          ).join('')}
        </select>
        <span class="quantity-label">Ø§Ù„ÙƒÙ…ÙŠØ©</span>
      </div>
      <div id="error-${i}" class="error-message"></div>
      
      <button onclick="addToCartWithQuantity('${i}', '${p.name.replace(/'/g,"\\'")}', ${p.price}, '${p.img}')">
        ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
      </button>
    </div>`;
  });
  document.getElementById('storeSection').innerHTML = html;
}

// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const logged = JSON.parse(localStorage.getItem('loggedUser'));
const bonusPercent = parseFloat(localStorage.getItem('bonus') || "1");
let purchases = JSON.parse(localStorage.getItem('purchases') || "[]");

function updateUserInfo() {
  if (logged) {
    const userPurchases = purchases.filter(p => p.code === logged.code);
    const total = userPurchases.reduce((sum, p) => sum + (p.price * p.qty), 0);
    const bonus = total * (bonusPercent / 100);
    document.getElementById('userInfo').textContent =
      `ğŸ‘¤ ${logged.name} | ÙƒÙˆØ¯: ${logged.code} | Ø§Ù„Ø¨ÙˆÙ†Øµ: ${bonus.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
  } else {
    document.getElementById('userInfo').textContent = "âš ï¸ Ù„Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯";
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
updateUserInfo();
loadProducts();
updateCartCount();
</script>
</body>
</html>