<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ / ØªØ³Ø¬ÙŠÙ„</title>
<style>
body { 
  font-family:'Tahoma', sans-serif; 
  margin:0; 
  padding:0; 
  background:#fff; 
  text-align:center;
}
header { 
  background:#6c757d; 
  color:#fff; 
  padding:12px; 
  font-size:20px;
}
nav { 
  background:#f8f9fa; 
  display:flex; 
  justify-content:space-around; 
  padding:8px; 
  border-top:1px solid #ddd; 
  border-bottom:1px solid #ddd;
}
nav a { 
  text-decoration:none; 
  color:#333; 
  font-size:14px;
}
nav a:hover { 
  color:#007bff;
}
section { 
  margin:10px auto; 
  width:90%; 
  max-width:450px; 
  text-align:right;
}
h3 { 
  font-size:18px; 
  margin:10px 0; 
  background:#007bff; 
  color:#fff; 
  padding:6px; 
  border-radius:4px; 
}
input[type=text], 
input[type=number], 
input[type=password] { 
  width:95%; 
  padding:8px; 
  margin:4px 0; 
  border:1px solid #ccc; 
  border-radius:4px;
}
button { 
  background:#007bff; 
  color:#fff; 
  padding:6px 10px; 
  border:none; 
  border-radius:4px; 
  cursor:pointer; 
  margin:5px 0;
}
button:hover { 
  background:#0056b3;
}
.logoutBtn { 
  background:#dc3545; 
}
.logoutBtn:hover { 
  background:#c82333;
}
table { 
  width:100%; 
  border-collapse:collapse; 
  margin-top:6px;
}
td, th { 
  border:1px solid #ccc; 
  padding:4px; 
  font-size:12px;
}
footer { 
  background:#f1f1f1; 
  text-align:center; 
  padding:8px; 
  font-size:13px; 
  color:#777; 
  border-top:1px solid #ddd; 
  margin-top:10px;
}
.redirect-notice {
  background: #fff3cd;
  color: #856404;
  padding: 10px;
  margin: 10px 0;
  border-radius: 4px;
  border: 1px solid #ffeeba;
}
</style>
</head>
<body>

<header>ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ / ØªØ³Ø¬ÙŠÙ„</header>

<nav>
  <a href="index.html">ğŸª Ø§Ù„Ù…ØªØ¬Ø±</a>
  <a href="cart.html">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</a>
  <a href="register.html">ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ</a>
</nav>

<section id="accountSection">
  <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
</section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
let users = JSON.parse(localStorage.getItem('users') || "[]");
let purchases = JSON.parse(localStorage.getItem('purchases') || "[]");
let logged = JSON.parse(localStorage.getItem('loggedUser'));

// Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
if(!localStorage.getItem('adminsAdded')){
  users.push({
    name: "Super Admin", 
    phone: "01552402912", 
    code: 790707071, 
    password: "790707071", 
    role: "superadmin"
  });
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('adminsAdded', "yes");
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ redirect ÙÙŠ URL
const urlParams = new URLSearchParams(window.location.search);
const redirectTo = urlParams.get('redirect');

function renderAccount(){
  let html = "";
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ redirect ÙˆÙ„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  if (redirectTo && !logged) {
    html += `
    <div class="redirect-notice">
      âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø©
    </div>`;
  }

  if(!logged){
    html += `
    <h3>ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
    <input type="text" id="newName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ">
    <input type="text" id="newPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)">
    <input type="password" id="newPass" placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±">
    <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>

    <h3>Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input type="text" id="loginPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    `;
  } else {
    // Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    let userPurchases = purchases.filter(p => p.phone === logged.phone);
    let total = userPurchases.reduce((sum, p) => sum + (p.price * p.qty), 0);
    let htmlTable = "";
    
    if(userPurchases.length){
      htmlTable = `<table>
        <tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr>`;
      
      userPurchases.slice(-5).forEach(p => {
        htmlTable += `<tr>
          <td>${p.product}</td>
          <td>${p.qty}</td>
          <td>${p.price * p.qty} Ø¬.Ù…</td>
        </tr>`;
      });
      
      htmlTable += `</table>`;
    } else {
      htmlTable = `<p>ğŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø¹Ø¯.</p>`;
    }

    html += `
    <h3>ğŸ‘¤ Ù…Ø±Ø­Ø¨Ù‹Ø§ ${logged.name}</h3>
    <div>ğŸ“ Ù‡Ø§ØªÙ: ${logged.phone}</div>
    <div>ğŸ”‘ ÙƒÙˆØ¯Ùƒ: ${logged.code}</div>
    <div style="margin-top:5px;">
      <button onclick="showEditPhone()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</button>
      <button onclick="showEditPass()">ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
    </div>
    <button class="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

    <h3>ğŸ’° Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
    <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù„Ø¹: ${userPurchases.length}</div>
    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${total} Ø¬.Ù…</div>
    ${htmlTable}
    `;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ redirect ÙˆØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (redirectTo) {
      setTimeout(() => {
        location.href = `${redirectTo}.html`;
      }, 1500);
    }
  }
  
  document.getElementById('accountSection').innerHTML = html;
}

function register(){
  let name = document.getElementById('newName').value.trim();
  let phone = document.getElementById('newPhone').value.trim();
  let password = document.getElementById('newPass').value.trim();
  let code = Math.floor(Math.random() * (9999 - 1111 + 1)) + 1111;

  if(!/^[\u0600-\u06FF ]{7,}$/.test(name)){ 
    alert("â— Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ."); 
    return;
  }
  
  if(!/^0\d{10}$/.test(phone)){ 
    alert("â— Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…."); 
    return;
  }
  
  if(password.length < 4){ 
    alert("â— ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±."); 
    return;
  }
  
  if(users.find(u => u.phone === phone)){ 
    alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„."); 
    return;
  }

  let user = {
    name, 
    phone, 
    code, 
    password, 
    role: "user"
  };
  
  users.push(user);
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('loggedUser', JSON.stringify(user));
  
  alert("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.");
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ redirect Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  if (redirectTo) {
    location.href = `${redirectTo}.html`;
  } else {
    location.reload();
  }
}

function login(){
  let phone = document.getElementById('loginPhone').value.trim();
  let password = document.getElementById('loginPass').value.trim();
  let user = users.find(u => u.phone === phone && u.password === password);
  
  if(user){
    localStorage.setItem('loggedUser', JSON.stringify(user));
    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.");
    
    // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (redirectTo) {
      location.href = `${redirectTo}.html`;
    } else if(user.role === "superadmin" || user.role === "admin") {
      location.href = "admin.html";
    } else {
      location.href = "index.html";
    }
  } else {
    alert("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
  }
}

function showEditPhone(){
  let newPhone = prompt("ğŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
  
  if(newPhone && /^0\d{10}$/.test(newPhone)){
    if(users.find(u => u.phone === newPhone)){ 
      alert("âš ï¸ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„."); 
      return;
    }
    
    let i = users.findIndex(u => u.phone === logged.phone && u.code === logged.code);
    users[i].phone = newPhone;
    logged.phone = newPhone;
    
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('loggedUser', JSON.stringify(logged));
    
    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
    renderAccount();
  } else {
    alert("âŒ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­.");
  }
}

function showEditPass(){
  let newPass = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (4 Ø£Ø­Ø±Ù ÙØ£ÙƒØ«Ø±):");
  
  if(newPass && newPass.length >= 4){
    let i = users.findIndex(u => u.phone === logged.phone && u.code === logged.code);
    users[i].password = newPass;
    logged.password = newPass;
    
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('loggedUser', JSON.stringify(logged));
    
    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
    renderAccount();
  } else {
    alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‚ØµÙŠØ±Ø©.");
  }
}

function logout(){
  localStorage.removeItem('loggedUser');
  location.reload();
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
renderAccount();
</script>

</body>
</html>