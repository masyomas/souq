<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</title>
<style>
body {
  font-family: 'Tahoma', sans-serif;
  margin: 0;
  padding: 0;
  background: #fff;
}
header {
  background: #007bff;
  color: #fff;
  padding: 8px;
  text-align: center;
  position: relative;
}
nav {
  background: #f8f9fa;
  display: flex;
  justify-content: space-around;
  padding: 8px;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}
nav a {
  text-decoration: none;
  color: #333;
  font-size: 14px;
}
.cart-container {
  padding: 10px;
}
.cart-item {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #eee;
  padding: 10px 0;
}
.cart-item img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  margin-left: 10px;
  border-radius: 4px;
}
.cart-item-info {
  flex: 1;
}
.delete-item {
  background: #dc3545;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
}
.cart-total {
  text-align: left;
  padding: 10px;
  font-weight: bold;
  font-size: 18px;
}
.checkout {
  background: #28a745;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  display: block;
  margin: 20px auto;
  font-size: 16px;
}
.empty-cart {
  text-align: center;
  padding: 40px;
  color: #777;
}
.purchase-history {
  margin-top: 30px;
  border-top: 2px solid #007bff;
  padding-top: 15px;
}
.purchase-history h3 {
  color: #007bff;
  text-align: center;
}
.purchase-history table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
.purchase-history th, .purchase-history td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
.purchase-history th {
  background-color: #f2f2f2;
}
.points-summary {
  background: #f8f9fa;
  padding: 10px;
  margin-top: 20px;
  border-radius: 4px;
  text-align: center;
  font-weight: bold;
}
.success-message {
  background: #d4edda;
  color: #155724;
  padding: 10px;
  margin: 10px 0;
  border-radius: 4px;
  text-align: center;
}
</style>
</head>
<body>

<header>
  <h1>ğŸ›’ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h1>
</header>

<nav>
  <a href="index.html">ğŸª Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
</nav>

<div id="successAlert" class="success-message" style="display:none;"></div>

<div class="cart-container" id="cartContainer">
  <p class="empty-cart">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>
</div>

<div class="cart-total">
  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="totalPrice">0</span> Ø¬Ù†ÙŠÙ‡
</div>

<button class="checkout" onclick="startCheckoutProcess()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</button>

<div class="purchase-history" id="purchaseHistory">
  <h3>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
  <table>
    <thead>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
        <th>Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      </tr>
    </thead>
    <tbody id="historyBody">
      <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage -->
    </tbody>
  </table>
</div>

<div class="points-summary" id="pointsSummary">
  Ù†Ù‚Ø§Ø·ÙŠ: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...
</div>

<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
const loggedUser = JSON.parse(localStorage.getItem('loggedUser'));
const BONUS_PERCENT = 5; // Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (5% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)
const STORE_PHONE = '01552402912';

// Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø³Ù„Ø©
function displayCart() {
  const cartContainer = document.getElementById('cartContainer');
  
  if (cart.length === 0) {
    cartContainer.innerHTML = '<p class="empty-cart">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>';
    document.getElementById('totalPrice').textContent = '0';
    return;
  }

  let html = '';
  let total = 0;

  cart.forEach(item => {
    total += item.price * item.quantity;
    html += `
    <div class="cart-item">
      <img src="${item.img}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/50'">
      <div class="cart-item-info">
        <h4>${item.name}</h4>
        <p>${item.price} Ø¬Ù†ÙŠÙ‡ Ã— ${item.quantity}</p>
      </div>
      <button class="delete-item" onclick="removeItem('${item.id}')">Ø­Ø°Ù</button>
    </div>`;
  });

  cartContainer.innerHTML = html;
  document.getElementById('totalPrice').textContent = total.toFixed(2);
}

// Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
function removeItem(productId) {
  cart = cart.filter(item => item.id !== productId);
  localStorage.setItem('cart', JSON.stringify(cart));
  displayCart();
  updateCartCount();
}

// Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
function displayPurchaseHistory() {
  if (!loggedUser) {
    document.getElementById('purchaseHistory').style.display = 'none';
    return;
  }

  const userPurchases = purchases.filter(p => p.code === loggedUser.code);
  const historyBody = document.getElementById('historyBody');
  
  if (userPurchases.length === 0) {
    historyBody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©</td></tr>';
    return;
  }

  let html = '';
  userPurchases.forEach((purchase, index) => {
    html += `
    <tr>
      <td>${index + 1}</td>
      <td>${purchase.product}</td>
      <td>${purchase.qty}</td>
      <td>${(purchase.price * purchase.qty).toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
      <td>${purchase.timestamp}</td>
    </tr>`;
  });

  historyBody.innerHTML = html;
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
function calculatePoints() {
  if (!loggedUser) {
    document.getElementById('pointsSummary').textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·';
    return;
  }

  const userPurchases = purchases.filter(p => p.code === loggedUser.code);
  const totalPurchases = userPurchases.reduce((sum, p) => sum + (p.price * p.qty), 0);
  const points = totalPurchases * (BONUS_PERCENT / 100);

  document.getElementById('pointsSummary').innerHTML = `
    Ù†Ù‚Ø§Ø·ÙŠ: <span style="color:#28a745;">${points.toFixed(2)} Ù†Ù‚Ø·Ø©</span>
    (${BONUS_PERCENT}% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
  `;
}

// Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡
function startCheckoutProcess() {
  if (cart.length === 0) {
    alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
    return;
  }

  if (!loggedUser) {
    if (confirm('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†ØŸ')) {
      location.href = 'register.html?redirect=cart';
    }
    return;
  }

  const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  if (confirm(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨: ${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŸ`)) {
    if (confirm(`Ø³ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ù‚Ù…: ${STORE_PHONE}\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
      window.open(`tel:${STORE_PHONE}`, '_blank');
      
      setTimeout(() => {
        confirmPurchase(total);
      }, 2000);
    }
  } else {
    confirmPurchase(total);
  }
}

// ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
function confirmPurchase(total) {
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ØŸ')) {
    completePurchase(total);
  } else {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ØŸ')) {
      alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡');
    } else {
      confirmPurchase(total);
    }
  }
}

// Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡
function completePurchase(total) {
  if (!loggedUser) {
    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡');
    location.href = 'register.html?redirect=cart';
    return;
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  const newPurchases = [];
  cart.forEach(item => {
    const purchase = {
      phone: loggedUser.phone,
      code: loggedUser.code,
      product: item.name,
      price: item.price,
      img: item.img,
      qty: item.quantity,
      timestamp: new Date().toLocaleString('ar-EG')
    };
    purchases.push(purchase);
    newPurchases.push(purchase);
  });

  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  localStorage.setItem('purchases', JSON.stringify(purchases));
  cart = [];
  localStorage.setItem('cart', JSON.stringify(cart));

  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡
  const successHtml = `
    <strong>ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
    Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: #${purchases.length}<br>
    ${newPurchases.map(p => `${p.product} (${p.qty})`).join('ØŒ ')}<br>
    Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡
  `;
  
  const successAlert = document.getElementById('successAlert');
  successAlert.innerHTML = successHtml;
  successAlert.style.display = 'block';

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
  displayCart();
  displayPurchaseHistory();
  calculatePoints();
  updateCartCount();

  // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
  setTimeout(() => {
    successAlert.style.display = 'none';
  }, 5000);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ header
function updateCartCount() {
  const count = cart.length;
  if (document.querySelector('.cart-count')) {
    document.querySelector('.cart-count').textContent = count;
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
displayCart();
displayPurchaseHistory();
calculatePoints();
</script>
</body>
</html>