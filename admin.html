<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff; }
header { background:#6c757d; color:#fff; padding:12px; font-size:20px; text-align:center; position:sticky; top:0; }
nav { display:flex; justify-content:space-around; background:#f8f9fa; border-bottom:1px solid #ddd; }
nav button { flex:1; padding:8px; border:none; background:none; cursor:pointer; font-size:14px; }
nav button.active { background:#007bff; color:#fff; }
section { margin:10px auto; width:95%; max-width:800px; }
h3 { background:#007bff; color:#fff; padding:6px; border-radius:4px; font-size:17px; margin-top:10px; }
table { width:100%; border-collapse:collapse; margin-top:8px; }
td, th { border:1px solid #ccc; padding:4px; font-size:13px; text-align:center; }
input.qtyInput { width:50px; text-align:center; }
button.action { background:#28a745; color:#fff; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; margin:2px; }
button.action:hover { background:#218838; }
.delBtn { background:#dc3545; }
.delBtn:hover { background:#c82333; }
input[type=number], input[type=text], input[type=password] { width:90%; padding:4px; margin:4px 0; border:1px solid #ccc; border-radius:4px; }
label { font-size:13px; }
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; margin-top:10px; }
.points-control { background:#f8f9fa; padding:10px; border-radius:4px; margin:10px 0; }
.img-thumbnail { width:50px; height:50px; object-fit:cover; border-radius:4px; }
.loading { text-align:center; padding:20px; }
</style>
</head>
<body>

<header>ğŸ’ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</header>

<nav id="tabs">
  <button onclick="showTab('dashboard')" class="active">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <button onclick="showTab('sales')">ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
  <button onclick="showTab('cart')">ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø©</button>
</nav>

<section id="content">
  <div class="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
document.addEventListener('DOMContentLoaded', function() {
  loadData();
});

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let logged, users, products, purchases, cart, pointsRate;

function loadData() {
  try {
    logged = JSON.parse(localStorage.getItem('loggedUser') || {};
    users = JSON.parse(localStorage.getItem('users') || [];
    products = JSON.parse(localStorage.getItem('products') || [];
    purchases = JSON.parse(localStorage.getItem('purchases') || [];
    cart = JSON.parse(localStorage.getItem('cart') || [];
    pointsRate = parseFloat(localStorage.getItem('pointsRate') || 5;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±
    if(logged.role !== "superadmin"){ 
      document.getElementById('content').innerHTML='ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„.'; 
      return;
    }
    
    showTab('dashboard');
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
    document.getElementById('content').innerHTML='âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
  }
}

function showTab(tab){
  try {
    document.querySelectorAll('#tabs button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`#tabs button[onclick*="${tab}"]`).classList.add('active');
    
    let content = document.getElementById('content');
    content.innerHTML = '<div class="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
    
    setTimeout(() => {
      if(tab === 'dashboard') renderDashboard();
      else if(tab === 'sales') renderSales();
      else if(tab === 'cart') renderCartControl();
    }, 100);
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨:', e);
    document.getElementById('content').innerHTML='âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.';
  }
}

// Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function renderDashboard(){
  let html = `<h3>ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
  <div>Ù…Ø±Ø­Ø¨Ù‹Ø§ ${logged.name} | Ù‡Ø§ØªÙ: ${logged.phone} | ÙƒÙˆØ¯Ùƒ: ${logged.code}</div>
  
  <div class="points-control">
    <h3>ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
    <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:</label>
    <input type="number" id="pointsRateInput" value="${pointsRate}" min="0" max="100" step="0.5">
    <span>%</span>
    <button onclick="updatePointsRate()" class="action">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨Ø©</button>
    <p>Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø³Ø¨Ø© 5% ÙˆÙ…Ø¬Ù…ÙˆØ¹ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ 1000 Ø¬.Ù…ØŒ Ø³ÙŠÙƒÙˆÙ† Ù„Ù‡ 50 Ù†Ù‚Ø·Ø©</p>
  </div>

  <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†</h3>
  <input type="text" id="adminName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">
  <input type="text" id="adminPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <label><input type="checkbox" id="permViewSales"> Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
  <label><input type="checkbox" id="permDeleteSales"> Ø­Ø°Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
  <button onclick="addAdmin()" class="action">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±</button>
  <table>
    <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th></tr>`;
  
  users.filter(u => u.role === "admin").forEach(u => {
    let permissions = [];
    if(u.permissions?.canViewSales) permissions.push("Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª");
    if(u.permissions?.canDeleteSales) permissions.push("Ø­Ø°Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª");
    
    html += `<tr>
      <td>${u.name}</td>
      <td>${u.phone}</td>
      <td>${u.role}</td>
      <td>${permissions.join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
    </tr>`;
  });
  
  html += `</table>`;
  document.getElementById('content').innerHTML = html;
}

// ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function renderSales(){
  let html = `<h3>ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>`;
  
  if(purchases.length > 0){
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    const totalSales = purchases.reduce((sum, p) => sum + (p.price * p.qty), 0);
    const uniqueCustomers = [...new Set(purchases.map(p => p.phone))].length;
    
    html += `
    <div style="background:#f8f9fa; padding:10px; margin-bottom:10px; border-radius:4px;">
      <strong>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</strong>
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${uniqueCustomers}</div>
      <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSales.toFixed(2)} Ø¬.Ù…</div>
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${purchases.length}</div>
    </div>
    <table>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø­Ø°Ù</th>
      </tr>`;
    
    purchases.forEach((p, i) => {
      html += `<tr>
        <td>${i+1}</td>
        <td>${p.name || p.phone}</td>
        <td>${p.product}</td>
        <td>${p.qty}</td>
        <td>${p.price} Ø¬.Ù…</td>
        <td>${(p.price * p.qty).toFixed(2)} Ø¬.Ù…</td>
        <td>${p.timestamp}</td>
        <td><button onclick="deletePurchase(${i})" class="delBtn">ğŸ—‘ï¸</button></td>
      </tr>`;
    });
    
    html += `</table>`;
  } else { 
    html += "<p>ğŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</p>"; 
  }
  
  document.getElementById('content').innerHTML = html;
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø©
function renderCartControl(){
  let html = `<h3>ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h3>`;
  
  if(cart.length > 0){
    html += `
    <table>
      <tr>
        <th>Ø§Ù„ØµÙˆØ±Ø©</th>
        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>`;
    
    cart.forEach((item, index) => {
      html += `
      <tr>
        <td><img src="${item.img}" class="img-thumbnail" onerror="this.src='https://via.placeholder.com/50'"></td>
        <td>${item.name}</td>
        <td>${item.price} Ø¬.Ù…</td>
        <td><input type="number" value="${item.quantity}" min="1" id="qty-${index}" style="width:60px;"></td>
        <td>${(item.price * item.quantity).toFixed(2)} Ø¬.Ù…</td>
        <td>
          <button onclick="updateCartItem(${index})" class="action">ğŸ”„</button>
          <button onclick="removeCartItem(${index})" class="delBtn">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    });
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    html += `
      <tr style="font-weight:bold;">
        <td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
        <td>${total.toFixed(2)} Ø¬.Ù…</td>
        <td></td>
      </tr>
    </table>`;
  } else {
    html += "<p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
  }
  
  document.getElementById('content').innerHTML = html;
}

// ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
function updatePointsRate(){
  let newRate = parseFloat(document.getElementById('pointsRateInput').value);
  if(isNaN(newRate)) { 
    alert("â— Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­."); 
    return; 
  }
  
  pointsRate = newRate;
  localStorage.setItem('pointsRate', pointsRate);
  alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø·.");
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ± Ø¬Ø¯ÙŠØ¯
function addAdmin(){
  let name = document.getElementById('adminName').value.trim();
  let phone = document.getElementById('adminPhone').value.trim();
  let pass = document.getElementById('adminPass').value.trim();
  let code = Math.floor(2000 + Math.random() * 8000);
  
  let permissions = {
    canViewSales: document.getElementById('permViewSales').checked,
    canDeleteSales: document.getElementById('permDeleteSales').checked
  };
  
  if(!name || !phone || !pass){ 
    alert("â— Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); 
    return; 
  }
  
  users.push({
    name,
    phone,
    password: pass,
    code,
    role: "admin",
    permissions
  });
  
  localStorage.setItem('users', JSON.stringify(users));
  alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ Ø¨ÙƒÙˆØ¯: ${code}`);
  renderDashboard();
}

// Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹
function deletePurchase(index){
  if(confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")){
    purchases.splice(index, 1);
    localStorage.setItem('purchases', JSON.stringify(purchases));
    renderSales();
  }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
function updateCartItem(index){
  const newQty = parseInt(document.getElementById(`qty-${index}`).value);
  if(isNaN(newQty) || newQty < 1){
    alert("â— Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©");
    return;
  }
  
  cart[index].quantity = newQty;
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartControl();
}

// Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
function removeCartItem(index){
  if(confirm("âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ")){
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCartControl();
  }
}
</script>

</body>
</html>